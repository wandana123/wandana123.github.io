<div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-07-24T07:37:37.000Z" title="2024/7/24 15:37:37">2024-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-07-24T08:04:16.806Z" title="2024/7/24 16:04:16">2024-07-24</time></span><span class="level-item">7 minutes read (About 1116 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/07/24/sql%E3%81%AEoracle%E8%A1%A8%E7%A9%BA%E9%97%B4%E6%89%A9%E5%AE%B9/">sqlのoracle表空间扩容</a></p><div class="content"><p>业务场景：</p>
<p>记录一下，2024 年 7 月 24，发生了一场不大不小的生产事故，导致一个地级市整个城市的某个业务系统停服一上午。也吸取一下深刻的教训。简单来讲，导致该事故最直接的原因就是这个业务系统现场人员为按时巡检导致，该系统数据库表空间满了没人知道，直到客户反馈业务传输有问题了，才开始排查，排查发现录入的信息数据库内无法查找，抽取日志查看发现表空间无法自动扩容。<br>
所以运维工作中，日常巡检的必要性还是毋庸置疑的。</p>
<p>扩容用有 dba 权限的账号，通过 plsql 客户端直接操作的。是使用增加数据文件的方式进行扩容。<strong>建议表空间超过 90% 就直接扩容</strong>。</p>
<p>–查询表空间使用情况<br>
 <code>SELECT a.tablespace_name &quot;表空间名&quot;,        round(total / (1024 * 1024 * 1024), 2) &quot;表空间大小(G)&quot;,        round(free / (1024 * 1024 * 1024), 2) &quot;表空间剩余大小(G)&quot;,        round((total - free) / (1024 * 1024 * 1024), 2) &quot;表空间使用大小(G)&quot;,        round((total - free) / total, 4) * 100 &quot;使用率 %&quot;   FROM (SELECT tablespace_name, SUM(bytes) free           FROM dba_free_space          GROUP BY tablespace_name) a,        (SELECT tablespace_name, SUM(bytes) total           FROM dba_data_files          GROUP BY tablespace_name) b  WHERE a.tablespace_name = b.tablespace_name</code></p>
<p>–临时表空间使用率<br>
 <code>select c.tablespace_name &quot;临时表空间名&quot;,        round(c.bytes / 1024 / 1024 / 1024, 2) &quot;临时表空间大小(G)&quot;,        round((c.bytes - d.bytes_used) / 1024 / 1024 / 1024, 2) &quot;临时表空间剩余大小(G)&quot;,        round(d.bytes_used / 1024 / 1024 / 1024, 2) &quot;临时表空间使用大小(G)&quot;,        round(d.bytes_used * 100 / c.bytes, 4) || '%' &quot;使用率 %&quot;   from (select tablespace_name, sum(bytes) bytes           from dba_temp_files          GROUP by tablespace_name) c,        (select tablespace_name, sum(bytes_cached) bytes_used           from v$temp_extent_pool          GROUP by tablespace_name) d  where c.tablespace_name = d.tablespace_name;</code></p>
<p>–查询表空间位置<br>
 <code>SELECT TABLESPACE_NAME &quot;表空间名&quot;, BYTES/1024/1024 &quot;表空间大小(M)&quot;, FILE_NAME &quot;文件路径&quot;,FILE_ID &quot;文件ID&quot; FROM DBA_DATA_FILES order by TABLESPACE_NAME,FILE_NAME; </code></p>
<p>扩容：<br>
–一个表空间最大为 32g，超过 32g 需要增加，例如：</p>
<pre><code>alter tablespace DAS ADD  datafile '/mc_data/oradata/zsk/das01.dbf' SIZE 30G;
</code></pre>
<p>扩展阅读：</p>
<p>删除表空间扩容文件:</p>
<pre><code>#alter tablespace 表空间名称 drop datafile 文件id;
alter tablespace UNDOTBS1 drop datafile 6;
</code></pre>
<p>删除临时表空间扩容文件:</p>
<pre><code>#alter tablespace 临时表空间名称 drop tempfile 文件id;
alter tablespace UNDOTBS2 drop tempfile 7;
</code></pre>
<p>清理表空间：</p>
<pre><code>alter  tablespace  IRFS_TEMP shrink space;
</code></pre>
<p>创建各种类型表空间：</p>
<pre><code>-- 创建大小为50mb的永久表空间TEST01，禁止自动扩展数据文件
create tablespace TEST01
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST01.dbf' size 50m
reuse autoextend off;

-- 创建永久表空间TEST02，允许自动扩展数据文件，本地管理方式
create tablespace TEST02
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST02.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local;

-- 创建永久表空间TEST03，允许自动扩展数据文件，本地管理方式，区分配方式为自动分配
create tablespace TEST03
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST03.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local autoallocate;

-- 创建永久表空间TEST04，允许自动扩展数据文件，本地管理方式，区分配方式为定制分配
create tablespace TEST04
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST04.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local uniform size 10m;

-- 创建永久表空间TEST05，允许自动扩展数据文件，本地管理方式，区分配方式为自动分配，段管理方式为自动管理
create tablespace test05
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST05.dbf' size 50m
reuse autoextend on next 10m maxsize 200M
extent management local autoallocate
segment space management auto;

-- 创建永久表空间TEST06，允许自动扩展数据文件，本地管理方式，区分配方式为定制分配，段管理方式为手动管理
create tablespace test06
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST06.dbf' size 50m
reuse autoextend on next 10m maxsize 200M
extent management local uniform size 10m
segment space management manual;
</code></pre>
<p>扩容 oracle 表空间的四种方法</p>
<p>示例 1：新增数据文件<br>
 ALTER TABLESPACE DSA ADD DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DAS01.DBF’ SIZE 102400M;</p>
<p>示例 2：新增数据文件，允许数据文件自动增长<br>
 ALTER TABLESPACE DSA ADD DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ SIZE 50M AUTOEXTEND ON NEXT 5M MAXSIZE 100M;</p>
<p>示例 3：允许已存在的数据文件自动增长<br>
 ALTER DATABASE DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ AUTOEXTEND ON NEXT 5M MAXSIZE 100M;</p>
<p>示例 4：手工改变已存在数据文件的大小<br>
 ALTER DATABASE DATAFILE ‘D:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ RESIZE 100M;</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-07-24T01:23:36.000Z" title="2024/7/24 09:23:36">2024-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-07-24T08:04:00.858Z" title="2024/7/24 16:04:00">2024-07-24</time></span><span class="level-item">a minute read (About 137 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/07/24/sql%E3%81%AEupdate-case-when-%E7%9A%84%E7%8E%A9%E6%B3%95/">sqlのupdate case when 的玩法</a></p><div class="content"><p>业务场景：</p>
<pre><code>有部分数据需要按条件做判断来update某个表的字段值。这个我是怎么实现的呢？
</code></pre>
<p>sql：</p>
<pre><code>UPDATE user 
SET order = CASE
WHEN id = '1' THEN '1' 
WHEN id = '2' THEN '2' 
END;
</code></pre>
<p>当然，这个语句还可以扩展一下，例如如下用法：</p>
<pre><code>示例1：
UPDATE graduates 
SET income = CASE
WHEN income = 20000 THEN income * 0.5 
WHEN income = 15000 THEN income + 500 
ELSE income 
END;

示例2：
UPDATE customers
SET age = CASE 
WHEN age &lt; 30 THEN age + 1
ELSE age
END;

示例3：
UPDATE customers
SET 
age = CASE 
    WHEN city = 'New York' THEN age + 1
    ELSE age
END,
country = CASE 
    WHEN city = 'New York' THEN 'USA'
    ELSE country
END;</code></pre>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-26T02:53:38.000Z" title="2024/6/26 10:53:38">2024-06-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-26T02:58:04.953Z" title="2024/6/26 10:58:04">2024-06-26</time></span><span class="level-item">a minute read (About 168 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/26/%E7%A5%9E%E9%80%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E6%9F%90%E4%B8%AA%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%89%80%E6%9C%89%E8%A1%A8%E7%9A%84%E5%A4%A7%E5%B0%8F/">神通数据库查询某个模式下所有表的大小</a></p><div class="content"><p>业务场景：<br>
有一天正常巡检发现数据库数据量在成倍增长。按道理，我的业务量，数据不可能会这么疯狂的增量。所以想看看到底是啥数据占用了这么多空间。检查发现有张表里写了文件导致的。</p>
<pre><code>下面是具体sql。
</code></pre>
<p><code>SELECT TMP.NSPNAME AS &quot;Sechma&quot;,        TMP.RELNAME,        SUM(TMP.SIZE) / 1024 /1024 AS &quot;Size(M)&quot;   FROM (SELECT N.NSPNAME, C.RELNAME,c.RELKIND, S.SIZE           FROM V_SEGMENT_INFO S, SYS_CLASS C, SYS_NAMESPACE N          WHERE S.RELID = C.OID            AND C.RELNAMESPACE = N.OID) TMP  WHERE  (TMP.NSPNAME='SYSDBA') and TMP.RELKIND ='r'  GROUP BY TMP.NSPNAME, TMP.RELNAME;</code></p>
<h1 id="搞定收工"><a class="markdownIt-Anchor" href="#搞定收工">#</a> 搞定，收工！！！</h1>
<h1 id="打卡下班"><a class="markdownIt-Anchor" href="#打卡下班">#</a> 打卡，下班！！！</h1>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-13T06:52:31.000Z" title="2024/6/13 14:52:31">2024-06-13</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-14T09:58:42.029Z" title="2024/6/14 17:58:42">2024-06-14</time></span><span class="level-item">a minute read (About 147 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/13/WIN10-WIN11%E7%BB%84%E7%AD%96%E7%95%A5%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">WIN10&amp;&amp;WIN11组策略无法打开的问题处理</a></p><div class="content"><p>问题描述：<br>
win + R 运行框内 gpedit.msc 调不起来组策略。</p>
<p>解决方案：<br>
1. 随便哪个位置，新建一个 txt 文档，粘贴如下内容。</p>
<p>@echo off</p>
<p>pushd “%~dp0”</p>
<p>dir /b C:\Windows\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientExtensions-Package~3*.mum &gt;List.txt</p>
<p>dir /b C:\Windows\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientTools-Package~3*.mum &gt;&gt;List.txt</p>
<p>for /f %%i in (‘findstr /i . List.txt 2^&gt;nul’) do dism /online /norestart /add-package:“C:\Windows\servicing\Packages%%i”</p>
<p>pause</p>
<p>2. 另存为 XXX.cmd</p>
<p>3. 文件名随便就行。然后以管理员权限运行。</p>
<p>最后跑完内容后，再 win + R 运行框内 gpedit.msc 就可以了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-05T03:05:00.000Z" title="2024/6/5 11:05:00">2024-06-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-05T03:06:01.160Z" title="2024/6/5 11:06:01">2024-06-05</time></span><span class="level-item">4 minutes read (About 584 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/05/NGINX%E6%90%AD%E5%BB%BA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">NGINX搭建负载均衡</a></p><div class="content"><p>#user  nobody;<br>
worker_processes  1;</p>
<p>#error_log  logs/error.log;<br>
#error_log  logs/error.log  notice;<br>
#error_log  logs/error.log  info;</p>
<p>#pid        logs/nginx.pid;</p>
<p>events {<br>
worker_connections  1024;<br>
}</p>
<p>http {<br>
include       mime.types;<br>
default_type  application/octet-stream;</p>
<pre><code>map $http_upgrade $connection_upgrade &#123;
	default upgrade;
	'' close;
   &#125;
   
#log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
#                  '$status $body_bytes_sent &quot;$http_referer&quot; '
#                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

#access_log  logs/access.log  main;

#上传文件最大限制
client_max_body_size 500M;

sendfile        on;
#tcp_nopush     on;

#keepalive_timeout  0;
keepalive_timeout  65;

types_hash_max_size 2048;
server_names_hash_max_size 2048;
types_hash_bucket_size 1024;

#gzip  on;


upstream websocket &#123;
		ip_hash;
		server ip:port;
		server ip:port;
		
    &#125;
	
    server &#123;
		listen     80;
		server_name www.baidu.com;
		
		
		location / &#123;
			
			#此处是nignx负载路径重写，重定向
			rewrite ^/$ http://$server_name/DW permanent;
			
			add_header X-Content-Type-Options nosniff;
			proxy_set_header X-scheme $scheme;
			
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host $http_host;
			proxy_set_header X-Nginx-Proxy true;
			proxy_hide_header X-Powered-By;
			proxy_hide_header Vary;
			proxy_pass http://websocket;
			proxy_http_version 1.1;
			proxy_set_header Origin '';
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_connect_timeout 1800; 
			proxy_read_timeout 900; 
			proxy_send_timeout 900; 
		


			#proxy_set_header   Host             $host; 
			#proxy_set_header   X-Real-IP        $remote_addr; 
			#proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for; 

		&#125;

	&#125;
	
	server &#123;
		listen     80;
		server_name www.qq.com;
		
		
		location / &#123;
			
			#此处是nignx负载路径重写，重定向
			rewrite ^/$ http://$server_name/DWeb/dw/index.html permanent;
			
			add_header X-Content-Type-Options nosniff;
			proxy_set_header X-scheme $scheme;
			
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host $http_host;
			proxy_set_header X-Nginx-Proxy true;
			proxy_hide_header X-Powered-By;
			proxy_hide_header Vary;
			proxy_pass http://websocket;
			proxy_http_version 1.1;
			proxy_set_header Origin '';
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_connect_timeout 1800; 
			proxy_read_timeout 900; 
			proxy_send_timeout 900; 
		


			#proxy_set_header   Host             $host; 
			#proxy_set_header   X-Real-IP        $remote_addr; 
			#proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for; 

		&#125;
	&#125;	
&#125;


#server &#123;
    #listen       80;
    #server_name  localhost;

    #charset koi8-r;

    #access_log  logs/host.access.log  main;

    #location / &#123;
    #    root   html;
    #    index  index.html index.htm;
    #&#125;

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    #error_page   500 502 503 504  /50x.html;
    #location = /50x.html &#123;
    #  root   html;
    #&#125;

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ &#123;
    #    proxy_pass   http://127.0.0.1;
    #&#125;

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ &#123;
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #&#125;

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht &#123;
    #    deny  all;
    #&#125;
#&#125;


# another virtual host using mix of IP-, name-, and port-based configuration
#
#server &#123;
#    listen       8000;
#    listen       somename:8080;
#    server_name  somename  alias  another.alias;

#    location / &#123;
#        root   html;
#        index  index.html index.htm;
#    &#125;
#&#125;


# HTTPS server
#
#server &#123;
#    listen       443 ssl;
#    server_name  localhost;

#    ssl_certificate      cert.pem;
#    ssl_certificate_key  cert.key;

#    ssl_session_cache    shared:SSL:1m;
#    ssl_session_timeout  5m;

#    ssl_ciphers  HIGH:!aNULL:!MD5;
#    ssl_prefer_server_ciphers  on;

#    location / &#123;
#        root   html;
#        index  index.html index.htm;
#    &#125;
#&#125;</code></pre>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-05-08T09:34:56.000Z" title="2024/5/8 17:34:56">2024-05-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-05-17T12:08:00.498Z" title="2024/5/17 20:08:00">2024-05-17</time></span><span class="level-item">a minute read (About 127 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/05/08/%E4%B8%9C%E6%96%B9%E9%80%9A%EF%BC%88TongWeb%EF%BC%89%E5%AE%9A%E6%97%B6%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF%E4%BB%BB%E5%8A%A1/">东方通（TongWeb）定时自动重启任务</a></p><div class="content"><p>#首先执行 <code>crontab -e</code>  进入定时任务内<br>
 #然后将下面的任务复制粘贴进去，wq! 保存退出<br>
 #重启 crontab 任务即可</p>
<p>#每天早晨 5:00 停机</p>
<pre><code>00 05 * * * cd /opt/TongWeb7.0/bin;./stopserver.sh
</code></pre>
<p>#每天早晨 5:04 启动</p>
<pre><code>04 05 * * * cd /opt/TongWeb7.0/bin;./startservernohup.sh
</code></pre>
<p>#每天中午 13:00 停机</p>
<pre><code>00 13 * * * cd /opt/TongWeb7.0/bin;./stopserver.sh
</code></pre>
<p>#每天中午 13:04 重启<br>
 04 13 * * * cd /opt/TongWeb7.0/bin;./startservernohup.sh</p>
<p><img src="/2024/05/08/%E4%B8%9C%E6%96%B9%E9%80%9A%EF%BC%88TongWeb%EF%BC%89%E5%AE%9A%E6%97%B6%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF%E4%BB%BB%E5%8A%A1/dingshirenwu.png" alt="crontab格式说明"></p>
<p>太高级了，简直简单的不要不要的！！！！！！！</p>
<p>又搞定了一个大事儿。</p>
</div></article></div>