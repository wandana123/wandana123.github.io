<div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-07-24T07:37:37.000Z" title="2024/7/24 15:37:37">2024-07-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-07-24T08:04:16.806Z" title="2024/7/24 16:04:16">2024-07-24</time></span><span class="level-item">7 minutes read (About 1116 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">sqlのoracle表空间扩容</h1><div class="content"><p>业务场景：</p>
<p>记录一下，2024 年 7 月 24，发生了一场不大不小的生产事故，导致一个地级市整个城市的某个业务系统停服一上午。也吸取一下深刻的教训。简单来讲，导致该事故最直接的原因就是这个业务系统现场人员为按时巡检导致，该系统数据库表空间满了没人知道，直到客户反馈业务传输有问题了，才开始排查，排查发现录入的信息数据库内无法查找，抽取日志查看发现表空间无法自动扩容。<br>
所以运维工作中，日常巡检的必要性还是毋庸置疑的。</p>
<p>扩容用有 dba 权限的账号，通过 plsql 客户端直接操作的。是使用增加数据文件的方式进行扩容。<strong>建议表空间超过 90% 就直接扩容</strong>。</p>
<p>–查询表空间使用情况<br>
 <code>SELECT a.tablespace_name &quot;表空间名&quot;,        round(total / (1024 * 1024 * 1024), 2) &quot;表空间大小(G)&quot;,        round(free / (1024 * 1024 * 1024), 2) &quot;表空间剩余大小(G)&quot;,        round((total - free) / (1024 * 1024 * 1024), 2) &quot;表空间使用大小(G)&quot;,        round((total - free) / total, 4) * 100 &quot;使用率 %&quot;   FROM (SELECT tablespace_name, SUM(bytes) free           FROM dba_free_space          GROUP BY tablespace_name) a,        (SELECT tablespace_name, SUM(bytes) total           FROM dba_data_files          GROUP BY tablespace_name) b  WHERE a.tablespace_name = b.tablespace_name</code></p>
<p>–临时表空间使用率<br>
 <code>select c.tablespace_name &quot;临时表空间名&quot;,        round(c.bytes / 1024 / 1024 / 1024, 2) &quot;临时表空间大小(G)&quot;,        round((c.bytes - d.bytes_used) / 1024 / 1024 / 1024, 2) &quot;临时表空间剩余大小(G)&quot;,        round(d.bytes_used / 1024 / 1024 / 1024, 2) &quot;临时表空间使用大小(G)&quot;,        round(d.bytes_used * 100 / c.bytes, 4) || '%' &quot;使用率 %&quot;   from (select tablespace_name, sum(bytes) bytes           from dba_temp_files          GROUP by tablespace_name) c,        (select tablespace_name, sum(bytes_cached) bytes_used           from v$temp_extent_pool          GROUP by tablespace_name) d  where c.tablespace_name = d.tablespace_name;</code></p>
<p>–查询表空间位置<br>
 <code>SELECT TABLESPACE_NAME &quot;表空间名&quot;, BYTES/1024/1024 &quot;表空间大小(M)&quot;, FILE_NAME &quot;文件路径&quot;,FILE_ID &quot;文件ID&quot; FROM DBA_DATA_FILES order by TABLESPACE_NAME,FILE_NAME; </code></p>
<p>扩容：<br>
–一个表空间最大为 32g，超过 32g 需要增加，例如：</p>
<pre><code>alter tablespace DAS ADD  datafile '/mc_data/oradata/zsk/das01.dbf' SIZE 30G;
</code></pre>
<p>扩展阅读：</p>
<p>删除表空间扩容文件:</p>
<pre><code>#alter tablespace 表空间名称 drop datafile 文件id;
alter tablespace UNDOTBS1 drop datafile 6;
</code></pre>
<p>删除临时表空间扩容文件:</p>
<pre><code>#alter tablespace 临时表空间名称 drop tempfile 文件id;
alter tablespace UNDOTBS2 drop tempfile 7;
</code></pre>
<p>清理表空间：</p>
<pre><code>alter  tablespace  IRFS_TEMP shrink space;
</code></pre>
<p>创建各种类型表空间：</p>
<pre><code>-- 创建大小为50mb的永久表空间TEST01，禁止自动扩展数据文件
create tablespace TEST01
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST01.dbf' size 50m
reuse autoextend off;

-- 创建永久表空间TEST02，允许自动扩展数据文件，本地管理方式
create tablespace TEST02
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST02.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local;

-- 创建永久表空间TEST03，允许自动扩展数据文件，本地管理方式，区分配方式为自动分配
create tablespace TEST03
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST03.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local autoallocate;

-- 创建永久表空间TEST04，允许自动扩展数据文件，本地管理方式，区分配方式为定制分配
create tablespace TEST04
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST04.dbf' size 50m
reuse autoextend on next 10m maxsize 200m
extent management local uniform size 10m;

-- 创建永久表空间TEST05，允许自动扩展数据文件，本地管理方式，区分配方式为自动分配，段管理方式为自动管理
create tablespace test05
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST05.dbf' size 50m
reuse autoextend on next 10m maxsize 200M
extent management local autoallocate
segment space management auto;

-- 创建永久表空间TEST06，允许自动扩展数据文件，本地管理方式，区分配方式为定制分配，段管理方式为手动管理
create tablespace test06
logging
datafile'F:\app\oraclezq\oradata\orcl\TEST06.dbf' size 50m
reuse autoextend on next 10m maxsize 200M
extent management local uniform size 10m
segment space management manual;
</code></pre>
<p>扩容 oracle 表空间的四种方法</p>
<p>示例 1：新增数据文件<br>
 ALTER TABLESPACE DSA ADD DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DAS01.DBF’ SIZE 102400M;</p>
<p>示例 2：新增数据文件，允许数据文件自动增长<br>
 ALTER TABLESPACE DSA ADD DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ SIZE 50M AUTOEXTEND ON NEXT 5M MAXSIZE 100M;</p>
<p>示例 3：允许已存在的数据文件自动增长<br>
 ALTER DATABASE DATAFILE ‘E:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ AUTOEXTEND ON NEXT 5M MAXSIZE 100M;</p>
<p>示例 4：手工改变已存在数据文件的大小<br>
 ALTER DATABASE DATAFILE ‘D:\ORACLE\PRODUCT\10.2.0\ORADATA\DSA01.DBF’ RESIZE 100M;</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>sqlのoracle表空间扩容</p><p><a href="https://wandana123.github.io/2024/07/24/sqlのoracle表空间扩容/">https://wandana123.github.io/2024/07/24/sqlのoracle表空间扩容/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>wandan</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-07-24</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-07-24</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>Afdian.net</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><div class="notification is-danger">You forgot to set the <code>business</code> or <code>currency_code</code> for Paypal. Please set it in <code>_config.yml</code>.</div><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/07/24/sql%E3%81%AEupdate-case-when-%E7%9A%84%E7%8E%A9%E6%B3%95/"><span class="level-item">sqlのupdate case when 的玩法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div>